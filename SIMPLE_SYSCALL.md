# æç®€ç³»ç»Ÿè°ƒç”¨æ¶æ„è¯´æ˜

## ğŸ“ æ–‡ä»¶ç»“æ„ï¼ˆä»…3ä¸ªæ–‡ä»¶ï¼‰

```
include/syscalls.h         # ç³»ç»Ÿè°ƒç”¨å®šä¹‰ï¼ˆå”¯ä¸€éœ€è¦ä¿®æ”¹ï¼‰
kernel/syscall.c          # å†…æ ¸ç³»ç»Ÿè°ƒç”¨å®ç°
user/syscalls.c           # ç”¨æˆ·æ€ç³»ç»Ÿè°ƒç”¨æ¥å£
```

## ğŸš€ æ·»åŠ æ–°ç³»ç»Ÿè°ƒç”¨ï¼ˆ3æ­¥ï¼‰

### æ­¥éª¤1ï¼šå®šä¹‰ç³»ç»Ÿè°ƒç”¨
åœ¨ `include/syscalls.h` çš„ `SYSCALL_LIST` ä¸­æ·»åŠ ä¸€è¡Œï¼š

```c
#define SYSCALL_LIST \
    SYSCALL(exit,   void, int status) \
    SYSCALL(write,  long, int fd, const void *buf, size_t len) \
    SYSCALL(read,   long, int fd, void *buf, size_t count) \
    SYSCALL(yield,  void) \
    SYSCALL(getpid, int) \
    SYSCALL(open,   int, const char *pathname, int flags) \
    SYSCALL(sleep,  int, int seconds)  // <-- æ–°ç³»ç»Ÿè°ƒç”¨
```

### æ­¥éª¤2ï¼šå®ç°å†…æ ¸å‡½æ•°
åœ¨ `kernel/syscall.c` ä¸­å®ç° `do_*` å‡½æ•°ï¼š

```c
int do_sleep(int seconds)
{
    printk("Sleeping for %d seconds\n", seconds);
    // å®ç°ç¡çœ é€»è¾‘
    return 0;
}
```

### æ­¥éª¤3ï¼šæ·»åŠ ç”¨æˆ·æ¥å£
åœ¨ `user/syscalls.c` ä¸­æ·»åŠ ç”¨æˆ·æ€åŒ…è£…ï¼š

```c
int sleep(int seconds) {
    return (int)syscall_raw(__NR_sleep, seconds, 0, 0, 0, 0, 0);
}
```

ç„¶åé‡æ–°ç¼–è¯‘å³å¯ï¼

## âœ¨ ç‰¹ç‚¹

- **æç®€**: åªæœ‰3ä¸ªæ–‡ä»¶éœ€è¦å…³å¿ƒ
- **è‡ªåŠ¨**: ç³»ç»Ÿè°ƒç”¨å·ã€å£°æ˜ã€è¡¨éƒ½è‡ªåŠ¨ç”Ÿæˆ
- **ç»Ÿä¸€**: æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨ç›¸åŒçš„è°ƒç”¨çº¦å®š
- **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶æ£€æŸ¥å‚æ•°ç±»å‹
- **æ˜“ç»´æŠ¤**: æ·»åŠ /åˆ é™¤ç³»ç»Ÿè°ƒç”¨åªéœ€ä¿®æ”¹å°‘é‡ä»£ç 

## ğŸ”§ å·¥ä½œåŸç†

1. **`include/syscalls.h`** ä½¿ç”¨å®é­”æ³•è‡ªåŠ¨ç”Ÿæˆï¼š
   - ç³»ç»Ÿè°ƒç”¨å· (`__NR_*`)
   - ç”¨æˆ·æ€å‡½æ•°å£°æ˜
   - å†…æ ¸æ€å‡½æ•°å£°æ˜

2. **`kernel/syscall.c`** å®ç°ï¼š
   - æ‰€æœ‰ `do_*` å‡½æ•°çš„å…·ä½“é€»è¾‘
   - ç³»ç»Ÿè°ƒç”¨è¡¨ï¼ˆå‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼‰
   - ç»Ÿä¸€çš„åˆ†å‘å‡½æ•° `do_syscall()`

3. **`user/syscalls.c`** æä¾›ï¼š
   - ç»Ÿä¸€çš„ `syscall_raw()` æ±‡ç¼–æ¥å£
   - æ‰€æœ‰ç”¨æˆ·æ€ç³»ç»Ÿè°ƒç”¨åŒ…è£…å‡½æ•°

è¿™æ ·ï¼Œä½ åªéœ€è¦åœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åå®ç°å¯¹åº”çš„ `do_` å‡½æ•°ï¼Œå°±èƒ½è®©æ•´ä¸ªç³»ç»Ÿè°ƒç”¨é“¾æ­£å¸¸å·¥ä½œï¼

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

```c
// ç”¨æˆ·ç¨‹åº
#include "syscalls.h"

int main() {
    write(1, "Hello World!\n", 13);
    int pid = getpid();
    sleep(2);
    exit(0);
}
```

ç›¸æ¯”ä¹‹å‰çš„25ä¸ªå¤æ‚æ–‡ä»¶ï¼Œç°åœ¨åªéœ€è¦å…³å¿ƒ3ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼Œç®€æ´æ˜äº†ï¼
